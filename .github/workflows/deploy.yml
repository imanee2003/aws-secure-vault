name: Secure DevSecOps Pipeline

on:
  push:
    branches: [ main ]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Bandit
        run: pip install bandit

      - name: Run Bandit
        run: bandit -r app/

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        run: checkov -f infrastructure.yaml --framework cloudformation

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Run OPA policies
        run: |
          opa eval --fail-defined \
          --input infrastructure.yaml \
          --data policies/aws-security.rego \
          "data.aws.security.deny"

  deploy:
    needs: security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Package Lambda
        run: |
          cd app
          zip -r ../deployment_package.zip lambda_function.py

      - name: Deploy Lambda
        uses: appleboy/lambda-action@master
        with:
          aws_access_key_id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws_region: us-east-1
          function_name: securedocvault-upload-logic
          zip_file: deployment_package.zip
